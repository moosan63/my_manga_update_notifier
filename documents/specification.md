# 漫画更新通知アプリ 仕様書

## 概要

RSSに対応していない漫画の更新情報をSlackに通知するWebアプリケーション。

## 機能要件

### 漫画管理機能

- **登録情報**
  - 漫画のタイトル
  - 漫画のページURL
  - 通知スケジュール（下記3パターンから1つ選択）

- **操作**
  - 一覧表示
  - 追加
  - 編集
  - 削除

### 通知スケジュール機能（新機能）

#### 通知パターン

1つの漫画につき、以下の3パターンから**1つだけ**選択可能。

| パターン | 説明 | 設定項目 |
|----------|------|----------|
| **週次** | 毎週指定の曜日に通知 | 曜日（1つ） |
| **隔週** | 2週間に1回、指定の曜日に通知 | 曜日（1つ） |
| **月次** | 毎月指定した日に通知 | 日付（複数選択可: 1〜31） |

#### 隔週の基準

- **登録日基準**: 漫画を登録した日を基準週として、隔週をカウント
- 例: 2024/1/8（月）に登録 → 1/8, 1/22, 2/5, 2/19... に通知

#### 月末処理（月次）

- 指定日が存在しない月は**スキップ**
- 例: 31日指定で30日までの月（4,6,9,11月）は通知しない
- 例: 29日以降指定で2月は、うるう年以外は通知しない（29日）、28日までの年は通知しない（30,31日）

### Slack通知機能

- 毎日0時（JST）に実行
- 当日の通知対象漫画をSlackに通知
  - 週次: 当日の曜日に該当
  - 隔週: 当日の曜日に該当 AND 基準週から偶数週目
  - 月次: 当日の日付に該当
- 1件ずつ「タイトル」「漫画のページURL」を投稿

### Slack設定機能

- Webhook URLをWeb画面から設定可能
- 設定の保存・更新

## 非機能要件

### ユーザー

- 自分専用（Basic認証で保護）

### 認証

- **方式**: Basic認証（`hono/basic-auth`ミドルウェア）
- **適用範囲**: 全HTTPリクエスト（Web画面・API）
- **除外対象**: Cron Triggers（scheduledイベントはHTTP経由でないため対象外）
- **認証情報の管理**:
  - ローカル開発: `.dev.vars`ファイル（gitignore対象）
  - 本番環境: Cloudflare Workers secrets
- **環境変数**:
  - `BASIC_AUTH_USER`: ユーザー名
  - `BASIC_AUTH_PASS`: パスワード

### 技術スタック

| 項目 | 技術 |
|------|------|
| 言語 | TypeScript |
| フレームワーク | HonoX |
| サーバー | Cloudflare Workers |
| データベース | Cloudflare D1 |
| スケジューラー | Cloudflare Workers Cron Triggers |

## データベース設計

### mangasテーブル（更新）

| カラム | 型 | 説明 |
|--------|-----|------|
| id | INTEGER | 主キー |
| title | TEXT | 漫画タイトル |
| url | TEXT | 漫画ページURL |
| schedule_type | TEXT | 通知パターン（'weekly' / 'biweekly' / 'monthly'） |
| day_of_week | INTEGER | 曜日（0=日〜6=土）。weekly/biweeklyで使用。monthlyはNULL |
| monthly_days | TEXT | 月次の日付リスト（JSON配列: "[12,24]"）。monthlyで使用。それ以外はNULL |
| base_date | TEXT | 隔週の基準日（ISO 8601形式）。biweeklyで使用。それ以外はNULL |
| created_at | TEXT | 作成日時 |
| updated_at | TEXT | 更新日時 |

### settingsテーブル

| カラム | 型 | 説明 |
|--------|-----|------|
| key | TEXT | 設定キー（主キー） |
| value | TEXT | 設定値 |

## マイグレーション

### 既存データの移行

既存の漫画データは以下のように自動移行:

- `schedule_type` = 'weekly'
- `day_of_week` = 既存の値をそのまま維持
- `monthly_days` = NULL
- `base_date` = NULL

## UI要件

### 漫画登録・編集画面

- 通知パターンを**ドロップダウン**または**ラジオボタン**で選択
- パターンに応じて入力フィールドを動的に表示:
  - 週次/隔週: 曜日選択（ドロップダウンまたはボタン）
  - 月次: 日付選択（チェックボックスまたはマルチセレクト、1〜31）

#### 隔週選択時の次回通知プレビュー

- 隔週を選択し曜日を指定すると、**次回の通知日をリアルタイムで表示**
- 表示例: 「次の通知: 2024/01/22（月）から開始」
- 登録日（現在日）を基準に、選択した曜日の次回該当日を計算して表示
- ユーザーがいつから通知が届くか直感的に把握できるようにする

### 漫画一覧画面

- 通知スケジュールを分かりやすく表示
  - 週次: 「毎週 火曜」
  - 隔週: 「隔週 火曜」
  - 月次: 「毎月 12, 24日」

## 受け入れ条件（Acceptance Criteria）

1. [ ] 漫画登録時に週次/隔週/月次から通知パターンを選択できる
2. [ ] 週次選択時、曜日を1つ指定できる
3. [ ] 隔週選択時、曜日を1つ指定でき、登録日が基準週として保存される
4. [ ] 隔週選択時、次回通知日がリアルタイムでプレビュー表示される
5. [ ] 月次選択時、1〜31の日付を複数選択できる
6. [ ] 週次の漫画は、指定曜日に毎週通知される
7. [ ] 隔週の漫画は、基準週から数えて2週ごとに通知される
8. [ ] 月次の漫画は、指定日に毎月通知される（存在しない日はスキップ）
9. [ ] 既存の漫画データが週次として正しく移行される
10. [ ] 漫画一覧で通知スケジュールが分かりやすく表示される
11. [ ] 漫画の編集で通知パターンを変更できる
