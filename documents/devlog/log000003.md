# Dev Log 000003 - Phase 2: 型定義・ユーティリティ関数実装

## 対象フェーズ
Phase 2: 型定義・ユーティリティ関数実装

## 実施日
2026-01-13

## 実施内容の要約

### 1. 型定義の更新
`app/lib/manga-handlers.ts` を更新:
- `ScheduleType` 型を追加: `'weekly' | 'biweekly' | 'monthly'`
- `Manga` インターフェースに新フィールド追加:
  - `scheduleType`: 通知パターン
  - `dayOfWeek`: NULLable化
  - `monthlyDays`: 月次日付配列
  - `baseDate`: 隔週基準日
- `MangaRow` インターフェースも同様に更新
- `toManga()` 関数を更新（monthlyDaysのJSONパース対応）

### 2. スケジュール判定ユーティリティ
`app/lib/schedule-utils.ts` を新規作成:

#### メイン関数
- `shouldNotifyWeekly()`: 週次スケジュールの通知判定
- `shouldNotifyBiweekly()`: 隔週スケジュールの通知判定
- `shouldNotifyMonthly()`: 月次スケジュールの通知判定
- `shouldNotify()`: 統合関数（scheduleTypeで振り分け）
- `getNextBiweeklyDate()`: UIプレビュー用の次回通知日計算

#### ヘルパー関数
- `getWeeksSinceBase()`: 基準日からの週数計算
- `isValidDayInMonth()`: 日付妥当性チェック
- `getJSTDateInfo()`: JST（UTC+9）での日付情報取得（内部関数）

### 3. テスト
`test/lib/schedule-utils.test.ts` を新規作成:
- 33テストケースを実装
- 週次: 4テスト
- 隔週: 5テスト
- 月次: 7テスト（閏年、月末処理含む）
- 統合関数: 4テスト
- ヘルパー関数: 9テスト
- 次回通知日計算: 5テスト

## 技術的判断・理由

### JST変換の実装
- Cloudflare WorkersはUTCで動作するため、JST（UTC+9）への変換が必要
- 通知判定関数内でJST変換を行い、日本時間での曜日/日付を正しく判定

### 隔週判定のアルゴリズム
- 基準日からの経過週数を計算し、偶数週（0, 2, 4...）で通知
- ミリ秒単位での週数計算（7日 = 604,800,000ms）

### 月次の存在しない日スキップ
- `isValidDayInMonth()`で指定日が存在するかチェック
- 閏年判定も含めて正確に判定

## レビュー内容と対応

### レビュー指摘事項
| 分類 | 内容 | 対応 |
|------|------|------|
| 推奨 | JST境界値テスト追加 | 今後のフェーズで対応可 |
| 推奨 | タイムゾーン一貫性 | コメント追加で対応可 |
| 推奨 | baseDateパース堅牢性 | バリデーション済み前提として許容 |
| 任意 | 定数抽出 | 今後のリファクタで対応可 |
| 任意 | 追加テストケース | 今後のフェーズで対応可 |

### 修正
必須の修正事項なし。推奨事項は今後のフェーズで対応予定。

## テスト結果
- 全67テストがパス（新規33 + 既存34）
- 既存機能への影響なし

## 問題点・反省
- 特になし
- TDDアプローチで堅牢な実装ができた

## 次フェーズへの申し送り
- Phase 3: Cronハンドラー更新
  - `shouldNotify()` 統合関数を使用して既存の曜日判定ロジックを置き換え
  - DBクエリを更新（全漫画を取得してフィルタリング、または各タイプごとにクエリ）
