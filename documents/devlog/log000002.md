# Dev Log 000002 - Phase 1: DBマイグレーション

## 対象フェーズ
Phase 1: DBマイグレーション

## 実施日
2026-01-13

## 実施内容の要約

### 作成したマイグレーション
`migrations/0002_schedule_columns.sql`

### 変更内容
1. `schedule_type` カラム追加（TEXT NOT NULL DEFAULT 'weekly'）
   - CHECK制約: 'weekly', 'biweekly', 'monthly' のみ許可
2. `monthly_days` カラム追加（TEXT NULL）
   - JSON配列文字列を格納
3. `base_date` カラム追加（TEXT NULL）
   - ISO 8601形式の日付文字列
4. `day_of_week` カラムをNULL許容に変更
   - SQLiteの制約によりテーブル再作成方式で移行

### マイグレーション方式
SQLiteではALTER TABLEでNOT NULL制約を変更できないため、以下の手順で移行：
1. 新スキーマで一時テーブル `mangas_new` を作成
2. 既存データを移行（schedule_type = 'weekly' を設定）
3. 元テーブルを DROP
4. 一時テーブルを `mangas` にリネーム

## 技術的判断・理由

### テーブル再作成方式を採用した理由
- SQLiteではALTER TABLEでカラム制約を変更できない
- D1のマイグレーションはファイル単位でトランザクション保証されるため、途中失敗時はロールバックされる
- 安全に既存データを保持したまま移行可能

### CHECK制約を追加した理由
- schedule_type に無効な値が入ることを防止
- アプリケーション層とDB層の両方でバリデーション

## レビュー内容と対応

### レビュー指摘事項
| 分類 | 内容 | 対応 |
|------|------|------|
| 必須 | トランザクション保証の確認 | D1マイグレーションがファイル単位でトランザクション保証することを確認 |
| 任意 | AUTOINCREMENTの採番テスト | テスト実行で確認（34件全パス） |

### 修正なし
レビュー指摘への対応で修正は不要と判断

## 問題点・反省
- wrangler d1 execute のコマンドライン引数でクォートの扱いに苦労した
- SQLファイル経由で実行することで解決

## テスト結果
- 全34テストがパス
- 既存機能への影響なし

## 次フェーズへの申し送り
- Phase 2: 型定義・ユーティリティ関数実装
  - Manga, MangaRow 型を新スキーマに合わせて更新
  - toManga 変換関数を更新
  - スケジュール判定ロジックをTDDで実装
